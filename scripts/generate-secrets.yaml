#!/bin/bash

# Generate secure passwords and secrets
DB_PASSWORD=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9!@#$%^&*()' | fold -w 32 | head -n 1)
JWT_SECRET=$(openssl rand -base64 32)
ADMIN_JWT_SECRET=$(openssl rand -base64 32)
API_TOKEN_SALT=$(openssl rand -base64 32)
TRANSFER_TOKEN_SALT=$(openssl rand -base64 32)
APP_KEY_1=$(openssl rand -base64 16)
APP_KEY_2=$(openssl rand -base64 16)
APP_KEY_3=$(openssl rand -base64 16)
APP_KEY_4=$(openssl rand -base64 16)

# Create stack.env with generated secrets
cat << EOL > stack.env
# Database Configuration
DATABASE_CLIENT=postgres
DATABASE_HOST=db
DATABASE_PASSWORD=${DB_PASSWORD}
DATABASE_PORT=5432
# DATABASE_SSL=false

# Strapi Configuration
NODE_ENV=production
STRAPI_APP_KEYS=${APP_KEY_1},${APP_KEY_2},${APP_KEY_3},${APP_KEY_4}
STRAPI_API_TOKEN_SALT=${API_TOKEN_SALT}
STRAPI_ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}
STRAPI_DATABASE_NAME=strapi_prod
STRAPI_DATABASE_USERNAME=strapi_user
STRAPI_TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}
STRAPI_JWT_SECRET=${JWT_SECRET}

# PostgreSQL Configuration
POSTGRES_USER=postgres
POSTGRES_PASSWORD=${DB_PASSWORD}
POSTGRES_DB=postgres
EOL

# Secure the env file
chmod 600 stack.env

# Save secrets to a secure file for backup
cat << EOL > ~/qtk/secrets_backup.txt
Database Password: ${DB_PASSWORD}
JWT Secret: ${STRAPI_JWT_SECRET}
Admin JWT Secret: ${STRAPI_ADMIN_JWT_SECRET}
Strapi App Keys: ${APP_KEY_1},${APP_KEY_2},${APP_KEY_3},${APP_KEY_4}
EOL

chmod 600 ~/qtk/secrets_backup.txt

echo "Secrets generated and saved to stack.env and secrets_backup.txt"
